# 📚 Object-Oriented Library (OOP Library Lending Service)
도서 대출/반납/예약 기능을 객체지향적으로 설계하며 테스트 코드 작성과 리팩터링을 통해 유지보수하기 쉬운 구조를 학습하는 프로젝트입니다.   
애플리케이션은 로컬에서 실행하고 데이터베이스는 Docker로 분리해 테스트 환경을 단순화했습니다.

# 목표
- 기능이 “그냥 동작”하는 수준을 넘어 협력하는 객체 설계를 통해 변경에 강한 구조 만들기
- 테스트 코드로 설계 의도와 책임 경계를 명확히 하기

# 설계 원칙
- **단일 책임(SRP)**: 하나의 클래스는 하나의 이유로만 바뀐다.
- **개방-폐쇄(OCP)**: 기존 코드를 수정하지 않고도 새로운 기능이나 정책을 확장할 수 있도록 설계한다.
- **의존 역전(DIP)**: 상위 수준 모듈은 하위 구현에 의존하지 않도록 한다.
- **캡슐화 & 불변성**: 도메인 상태는 생성 시 유효성 보장하고 가급적 불변 객체 지향한다.
- **Tell, Don’t Ask**: 객체의 상태를 꺼내기보다 행동을 시켜 협력하게 만든다.
- **값 객체 우선**: 원시값 대신 의미 있는 타입으로 유효성과 의도를 함께 표현한다.
- **KISS & YAGNI**: 단순함을 유지하고, 지금 필요한 기능만 구현한다.

# 기능 목록

## 유스케이스 (Use Cases)

### 대출
- 목적 : 회원이 특정 소장본을 대출한다.
- 행위자 : Member
- 조건 :
  - 회원이 `ACTIVE` 상태여야 한다. (만료되지 않은 패널티가 있으면 안 된다)
  - 대출하려는 도서에 `AVAILABLE` 상태의 `StoredBook`이 최소 1권 이상 존재해야 한다.
  - 타인 예약 대기열이 존재할 때, 본인이 선두가 아니면 대출할 수 없다.
  - 회원의 현재 대출 권수가 정책이 허용하는 상한 이하여야 한다. (확장 대기)
- 흐름 :
  - 시스템이 `Member`와 `Book`을 조회한다.
  - 현재 시각 기준으로 `member.releasePenaltyIfExpired(clock)` 을 호출해 만료된 패널티를 해제한다.
  - `member.canBorrow()` 로 대출 가능 여부를 확인하고 불가능하면 거절한다.
  - `Book`에서 `StoredBooks`를 통해 대출 가능한 소장본(`AVAILABLE`)을 선택한다.
  - `LoanPolicy`와 대출 시각을 이용해 최초 반납 예정일을 계산하고 `Loan`을 생성한다.
  - `StoredBook`을 `LOANED` 상태로 전이하고, `Loan`을 저장한다.
  - 생성된 `Loan`의 반납 예정일을 응답한다.

### 반납
- 목적 : 대출한 소장본을 반납한다.
- 행위자 : Member
- 조건 :
  - 반납하려는 대출 건(`Loan`)이 존재해야 한다.
- 흐름 :
  - 시스템이 `Loan`을 조회한다.
  - 이미 반납된 대출이라면 아무 변경 없이 멱등 처리한다.
  - 반납 가능한 상태라면 `Loan`에 반납 시각을 반영하고, 연체 여부를 판단한다.
  - 연체된 경우, 연체 기간에 따라 `Penalty`를 생성하고 `member.applyPenalty(penalty)`로 회원에게 패널티를 부여한다.
  - 연체 여부와 상관없이, `StoredBook`의 상태를 갱신한다.
    - 예약 대기열이 없다면 `AVAILABLE`로 전환한다.
    - 예약 대기열이 있다면, `Book.assignHoldIfReservationExists(...)`를 통해 선두 예약자에게 보류를 부여하고 `ON_HOLD` 상태로 전환한다.

### 연장
- 목적 : 대출 기한을 연장한다.
- 행위자 : Member
- 조건 : 
  - 대출이 진행 중(반납되지 않은 상태)이어야 한다.
  - 연장 시점 기준으로 연체 상태가 아니어야 한다.
  - 다른 회원의 예약 대기열이 존재하지 않아야 한다.
  - 연장 횟수를 넘어가는지 확인한다.
  - 정책이 허용하는 연장 횟수/기간을 초과하지 않아야 한다. (확장 대기)
- 흐름 :
  - 시스템이 `Loan`을 조회한다.
  - `Reservation`(또는 `Reservations`)을 통해 해당 도서에 타인의 예약 대기열이 있는지 확인한다.
  - 연체 상태 / 예약 대기 여부 / 연장 가능 횟수 등을 종합해 연장 가능 여부를 판단한다.
  - 연장이 가능하면, 현재 반납 예정일과 `LoanPolicy`를 사용해 새 반납 예정일을 계산한다.
  - `Loan`의 반납 예정일을 갱신하고, 연장 횟수 등의 상태를 함께 업데이트한다.

### 예약
- 목적 : 대출중인 도서를 예약한다.
- 행위자 : Member
- 조건 :
  - 회원이 `ACTIVE` 상태여야 한다. (활성 패널티가 없어야 한다)
  - 회원이 이미 해당 도서를 대출 중이거나 동일 도서에 대해 활성 `Reservation`을 가지고 있지 않아야 한다.
  - 예약 대기열의 최대 인원 수(ReservationPolicy)가 초과되지 않아야 한다.
  - 도서의 모든 소장본이 대출 중일 때만 예약을 허용한다.
- 흐름 :
  - 시스템이 `Member`와 `Book`을 조회한다.
  - `Book`이 가진 `StoredBooks`를 통해 모든 소장본이 `LOANED` 상태인지 확인한다.
  - 모든 소장본이 대출 중인 경우에만, `Book.tryReserve(memberId, maxQueueSize, clock)`를 호출한다.
  - 예약이 성공하면, 예약 번호나 상태 등을 응답한다.

## 도메인

### Member
- 역할/책임 : `MemberStatus`와 `Penalty`를 기반으로 대출 / 예약 / 연장 자격을 판단하는 기준을 제공한다.
- 행동 : 
  - [x] 회원 상태와 패널티를 기준으로 대출 가능 여부를 판단한다.
  - [x] 연체 등 규칙 위반 시 패널티를 적용하고 회원 상태를 `SUSPENDED`로 전환한다.
  - [x] 시간 경과에 따라 만료된 패널티를 해제하고 회원 상태를 `ACTIVE`로 복구한다.

### Penalty
- 역할/책임 : 회원에게 부여된 제재 정보를 표현하는 값 객체로, 패널티 시작/종료 시각과 사유를 캡슐화한다.
- 행동 :
  - [x] 주어진 시각 기준으로 패널티가 활성 상태인지 판단한다.
  - [x] 패널티의 시작 시각/종료 시각/사유를 조회할 수 있다.

### Book
- 역할/책임 : 책 한 권의 메타데이터를 관리하며, 여러 소장본과 예약을 아우르는 집합 루트로서 이들 간의 정책을 조율한다.
- 행동 :
  - [x] 새 책 등록 시 초기 소장본을 함께 생성한다.
  - [x] 운영 중 가용 소장본을 추가 등록한다.
  - [x] 소장본 1권을 해당 `Book`과 연관관계를 설정한다.
  - [x] 모든 소장본이 대출 중일 때만 예약 접수를 허용한다.
  - [x] 가용 소장본이 생기면 예약 대기열의 선두에게 우선권이 넘어가도록 한다.

### StoredBook
- 역할/책임 : 동일 `Book`에 속한 한 권의 실물을 나타내며 `AVAILABLE`/`LOANED`/`ON_HOLD` 등 권별 상태 전이를 관리한다.
- 행동 : 
  - [x] 대출 가능일 때만 대출로 전환한다.
  - [x] 반납 시 예약 대기열이 없으면 다시 대출 가능으로 상태를 갱신한다.
  - [x] 반납 시 예약 대기열이 있으면 지정 회원의 픽업 대기로 전환된다.

### StoredBooks
- 역할/책임 : 동일 `Book`에 속한 모든 `StoredBook` 집합을 캡슐화
- 행동 :
  - [x] 유효한 소장본만 추가한다.
  - [x] 모든 소장본이 LOANED일 때만 true (예약 가능 여부 판단)
  - [x] 첫 번째 `AVAILABLE` 상태의 소장본을 조회한다.

### Loan
- 역할/책임 : 특정 `StoredBook`이 특정 `Member`에게 대출된 사실과 생명주기를 관리한다.
- 행동 :
  - [x] 대출이 된 도서만 반납 / 연장이 가능하다.
  - [x] 연체 중이거나 타인의 예약 대기열이 존재하면 연장을 거절한다.
  - [x] 반납이 확정되면 그 결과가 `StoredBook`의 상태가 갱신된다.

### Reservation
- 역할/책임 : 특정 `Book`에 대해 한 회원의 단건 예약을 나타내고, 예약의 상태 전이를 관리한다.
- 행동 :
  - [x] 예약 생성 시 `QUEUED` 상태로 시작한다.
  - [x] 보류 기한과 대상 소장본을 지정하여 `HOLD_READY`로 전이할 수 있다.
  - [x] 보류 기한이 지나면 `EXPIRED`로 전이된다.
  - [x] 대출 완료 시 `LOAN_COMPLETE` 상태로 전이된다.

### Reservations
- 역할/책임 : 동일 `Book`에 대한 예약 대기열 전체를 관리한다.
- 행동 :
  - [x] 동일 회원의 중복 예약을 금지한다.
  - [x] 대기열 상한을 초과하면 예약을 거절한다.
  - [x] 선두 대기자에게 보류를 부여한다.
  - [x] 보류 기한 만료 여부를 판단하여 상태를 전이하고 만료된 소장본의 ID 목록을 반환한다.
  - [x] HOLD_READY 상태 중 특정 회원의 예약이 본인의 예약이 맞는지 조회한다.

### ReservationPolicy
- 역할/책임 : 예약 대기열 크기, 보류 기간, 소장본 선택 기준 등을 결정한다.
- 행동 : 
  - [x] 예약 대기열의 최대 크기를 반환한다.
  - [x] 예약 보류 유지 기간을 반환한다.
  - [x] 대출 가능한 소장본 중 하나를 선택한다.

### LoanPolicy
- 역할/책임 : 대출 및 연장 시점에 따라 반납 기한을 계산하는 정책만을 담당한다.
- 행동 :
  - [x] 대출 시점과 정책에 따라 최초 반납 예정일을 계산한다.
  - [x] 현재 반납 예정일과 정책에 따라 연장 후 반납 예정일을 계산한다.